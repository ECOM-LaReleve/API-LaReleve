apply plugin: 'ear'

/* Content of EAR */
dependencies {
    deploy project(path: ':logger', configuration: 'archives')
    deploy project(path: ':lareleve-web', configuration: 'archives')
}

ear {
    deploymentDescriptor {
        applicationName = "laReleve"
        initializeInOrder = true
        displayName = "laReleve"
        description = "laReleve"

        /* Content of application.xml in EAR */
        webModule("lareleve-web.war", "/")
        module("logger.jar", "java")
    }
}

/* Eclipse plugin */
apply plugin: 'eclipse-wtp'
eclipse.project {
    natures 'org.springsource.ide.eclipse.gradle.core.nature'
}

/* DOCKER PLUGIN */
/* Add docker plugin as dependency */
buildscript {
    repositories {
        jcenter()
    }

    dependencies {
        classpath 'com.bmuschko:gradle-docker-plugin:3.0.3'
    }
}

/* DOCKER PLUGIN CONFIGURATION */
apply plugin: 'com.bmuschko.docker-remote-api'
apply plugin: 'com.bmuschko.docker-java-application'
repositories {
    mavenCentral()
}
docker {
    url = System.env.DOCKER_HOST
    certPath = new File(System.env.DOCKER_CERT_PATH)
}

/* Imports */
import com.bmuschko.gradle.docker.tasks.image.Dockerfile
import com.bmuschko.gradle.docker.tasks.image.DockerBuildImage

/* Creation of Dockerfile */
task createDockerfile(type: Dockerfile) {
    destFile = project.file('build/Dockerfile') // Location of Dockerfile

    /* Content of Dockerfile */
    from 'jboss/wildfly:latest'
    maintainer 'RÃ©mi GATTAZ "remi.gattaz@gmail.com"'
    exposePort 8080, 9990
    addFile 'libs/lareleve.ear', '/opt/jboss/wildfly/standalone/deployments/'
    runCommand '/opt/jboss/wildfly/bin/add-user.sh admin Admin#70365 --silent'
    defaultCommand '/opt/jboss/wildfly/bin/standalone.sh', '-b', '0.0.0.0', '-bmanagement', '0.0.0.0'

    /* Create 2 environment variables used to create an admin user in wildfly. These two values can
    be overrriden at the creation of a container */
    // environmentVariable 'ADMIN_USERNAME', 'admin'
    // environmentVariable 'ADMIN_PASSWORD', 'Admin#70365'
    // defaultCommand 'sh', '-c', '/opt/jboss/wildfly/bin/add-user.sh ${ADMIN_USERNAME} ${ADMIN_PASSWORD} --silent && /opt/jboss/wildfly/bin/standalone.sh -b 0.0.0.0 -bmanagement 0.0.0.0'
    // environmentVariable 'ENV_VAR_1', 'CONTENT_VAR_1'
    // volume '/path/to/volume1', '/path/to/volume2', '/path/to/volume3'

}

/* Creation of Docker image */
task buildImage(type: DockerBuildImage) {
    dependsOn build
    dependsOn createDockerfile

    inputDir = createDockerfile.destFile.parentFile
    tag = 'lareleve:latest'
}
